<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<title>Barista Homepage</title>
<link rel="stylesheet" href="css/bootstrap.css" />
<link rel="stylesheet" href="css/app.css" />
<style>
input.ng-valid {
	background-color: lightgreen;
}

input.ng-dirty.ng-invalid-min {
	background-color: yellow;
}
body {
	background-color: rgb(207, 176, 145);
}
</style>
</head>
<body>
	<script
		src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.4/angular.js"></script>
	<script>
		/*<![CDATA[*/
		var app = angular.module('myApp', []);
		app.controller('recipesCtrl', function($scope, $http, $q) {
			/*All previous implementation for edit recipe that will be deleted upon convergence*/
			console.log("Hit!");
			
			$scope.canSubmit = false;
			$scope.selected = false;
	
			$scope.inventory = '';
			
			$scope.ingredient = {
				name: '',
				amount: '',
			};
			
			$scope.inv = {
				ingredients: ''
			};
			
			$scope.recipe = {
				name: '',
				price: '',
				ingredients: ''
			};
			
			$scope.OGrecipe = {
				name: '',
				price: '',
				ingredients: ''
			};
			
			$http.get("/api/v1/recipes").then(function(response) {
				$scope.recipes = response.data;
			});
			
			$http.get("/api/v1/inventory").then(function(response) {
				$scope.inv = response.data;
				$scope.inventory = $scope.inv.ingredients;
			});
			
			$scope.getRecipe = function() {
				$http.get("/api/v1/recipes/" + $scope.recipe.name).then(function(response) {
					$scope.recipe = response.data;
				}, function(rejection) {
					console.error("Error while getting Recipe");
				})
			}
			
			$scope.getIngredients = function() {
				$http.get("/api/v1/recipes/" + $scope.recipe.name + "/ingredients").then(
					function(success) {
							$scope.ingredients = success.data;
						}, function(error) {
							if (error.status === 404) {
								  console.error("Error there's no ingredients", error);
					        } else {
					          console.error("Error while getting ingredients", error);
					        }
					    });
			}
			
			$scope.clear = function() {
				if($scope.canSubmit){
					$http.put("/api/v1/recipes/" + $scope.recipe.name, $scope.OGrecipe);
				}
		        
				$scope.reset();
			}

			$scope.submit = function() {
				$scope.editRecipe();
				$scope.canSubmit = false;
				$scope.reset();
			}
			
			$scope.selectRecipe = function() {
				$scope.getRecipe();
				
				$http.get("/api/v1/recipes/" + $scope.recipe.name).then(function(response) {
					$scope.OGrecipe = response.data;
				}, function(rejection) {
					console.error("Error while getting Recipe");
				})
				
				$scope.getIngredients();
				$scope.selected = true;
				$scope.canSubmit = false;
			}

			$scope.editRecipe = function() {
				$scope.resetMsg();

				$http.put("/api/v1/recipes/" + $scope.recipe.name, $scope.recipe).then(
						function(response) {
							$scope.editsuccess = true;
							$scope.canSubmit = true;
							$scope.getRecipe();
						}, function(rejection) {
							$scope.failure = true;
							console.error("Error while editing Recipe!");
						});
			}
			
			$scope.addIngredient = function() {
				$scope.resetMsg();
				
				if($scope.ingredient.amount > 0 && $scope.ingredient.name != ''){

					$http.post("/api/v1/recipes/" + $scope.recipe.name + "/ingredients", $scope.ingredient).then(
						function(success) {/*  somehow make a post too for ingredient */
							$scope.isuccess = true;
							
							$scope.getIngredients();
							$scope.canSubmit = true;
							$scope.getRecipe();
							
						}, function(error) {
						    alert("Cannot add duplicate ingredient. Try Again.");
					    });
				} else {
					alert("Invalid Input. Try Again.");
				}
				
				$scope.resetIngredient();
					   				
			}
			
			$scope.editIngredient = function(){
				$scope.resetMsg();
				
				$scope.updateIngredient.name = $scope.name;
				
				if($scope.updateIngredient.amount > 0 && $scope.updateIngredient.name != ''){
				
					$http.put("/api/v1/recipes/" + $scope.recipe.name + "/ingredients/" + $scope.name, $scope.updateIngredient)
		            	.then(
		            	function (response) {
		            		console.log(response);
		    				$scope.editsuccess = true;	
		    				$scope.canSubmit = true;
		                	$scope.getIngredients();
		                	$scope.getRecipe();
		            	},
		            	function(rejection){
		                	console.error('Error while editing ingredient');
		                	console.log(rejection);
		                
							$scope.editsuccess = false;
		            	}
		        	);
		        } else {
		        	alert("Invalid Input. Try Again.");
		        }
		        $scope.resetIngredient();
			}
			
			$scope.deleteIngredient = function(){
				$scope.resetMsg();
				
				if($scope.ingredients.length > 1){
					$http.delete("/api/v1/recipes/" + $scope.recipe.name + "/ingredients/" + $scope.name)
		            	.then(
		            	function (response) {
		            		console.log(response);
		    				$scope.delsuccess=true;	
		    				$scope.canSubmit = true;
		                	$scope.getIngredients();
		                	$scope.getRecipe();
		            	},
		            	function(rejection){
		                	console.error('Error while deleting ingredient');
		                	console.log(rejection);		                
		            	});
		        } else {
		        	alert("Recipe must have at least one ingredient.");
		        }
		        
		        $scope.resetIngredient();
		        
			}
			
			$scope.reset = function() {
				$scope.recipe = {
					name : '',
					price : '',
					ingredients: ''
				};
				$scope.OGrecipe = {
					name: '',
					price: '',
					ingredients: ''
				};
				$scope.canSubmit = false;
				$scope.selected = false;
				$scope.resetIngredient();
				$scope.ingredients = '';
				if (undefined != $scope.editRecipeForm) {
					$scope.editRecipeForm.$setPristine(); // reset Form
				}
				$scope.canSubmit = false;
			}
			
			$scope.resetIngredient = function() {
				$scope.ingredient = {
					name: '',
					amount : '',
						
				};
				$scope.updateIngredient = {
					name: '',
					amount : '',
						
				};
				if (undefined != $scope.addRecipeForm) {
					$scope.addRecipeForm.$setPristine(); // reset Form
				}
			}
			
			$scope.signOut = function() {
				if($scope.canSubmit){
					alert("Current Recipe has not been submitted. Submit or Cancel before returning home.");
				} else {
					window.location.href = "/index";
				}
				
			}
			
			$scope.resetMsg = function() {
				$scope.editsuccess = false;
				$scope.delsuccess = false;
				$scope.isuccess = false;
				$scope.success = false;
			}

			$scope.reset();

		});
		/*]]>*/
	</script>
	
	<div class="row text-center"> <div class="col-md-12 bg-light text-right"> <button class="btn btn-default" ng-click="signOut();"> 
		<img src="https://static.vecteezy.com/system/resources/thumbnails/000/574/782/small/vector60-5835-01.jpg" alt="Signout" width="25" height="25"> </button> </div> 
		<h1>Barista Homepage</h1> 
		<br> 
		<br> 
	</div>


	<div class="generic-container ng-cloak" ng-app="myApp"
		ng-controller="recipesCtrl as ctrl">
				<form ng-submit="submit()" name="editRecipeForm"
					class="form-horizontal">					
						<div class="row">
							<label class="col-lg-12 control-lable" for="list" style="font-size: 15px">Current Orders:</label>
                              <div class="col-md-6">
                              <table class="table table-striped">
                                <thead>
                                  <tr>
                                    <th>Order #</th>
                                    <th>Recipe Info</th>
                                    <th>Status</th>
                                    <th>Completed</th>
                                  </tr>
                                </thead>
                                <tbody>
                                  <tr ng-repeat="ingredient in ingredients">       
                                      <td>{{ ingredient.amount }}</td>
                                      <td>{{ ingredient.name }}</td>
                                      <td>button</td>
                                      <td>
                                      	<label>
                                          <input type="radio" name="name" ng-model="$parent.name" value="{{ingredient.name}}">
                                        </label>
                                      </td>
                                  </tr>
                                </tbody>
                              </table>
                              </div>
                             <div class="form-actions floatRight">
								<button type="button" ng-click="submit()"
										class="btn btn-default btn-sm"
										ng-disabled="!canSubmit">Complete Order</button>
							</div>
					    </div>
					
						<div class="row">
							<label class="col-lg-12 control-lable" for="list" style="font-size: 15px">All Orders:</label>
                              <div class="col-md-6">
                              <table class="table table-striped">
                                <thead>
                                  <tr>
                                    <th>Fulfill</th>
                                    <th>Order #</th>
                                    <th>Recipe Info</th>
                                    <th>Status</th>
                                  </tr>
                                </thead>
                                <tbody>
                                  <tr ng-repeat="ingredient in ingredients">
                                     <td>
                                      <label>
                                          <input type="radio" name="name" ng-model="$parent.name" value="{{ingredient.name}}">
                                        </label>
                                      </td>
                                      <td>{{ ingredient.name }}</td>
                                      <td>{{ ingredient.amount }}</td>
                                      <td>button</td>
                                  </tr>
                                </tbody>
                              </table>
                              </div>
                    </div>
					<div class="row" >
						<div class="form-actions floatRight">
								<button type="button" ng-click="submit()"
										class="btn btn-default btn-sm"
										ng-disabled="!canSubmit">Fulfill Order</button>
						</div>
					</div>
					<br>	
				</form>
					
			<div class="panel-footer">
				<div ng-show="delsuccess">Ingredient Deleted!</div>
				<div ng-show="editsuccess">Recipe Edited!</div>
				<div ng-show="isuccess">Ingredient Added!</div>
			</div>

	</div>
	
</body>
</html>
